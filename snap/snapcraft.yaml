name: frog # you probably want to 'snapcraft register <name>'
base: core22 # the base snap is the execution environment for this snap
version: '1.3.0' # just for humans, typically '1.2+git' or '1.3.2'
grade: stable # must be 'stable' to release into candidate/stable channels
confinement: strict # use 'strict' once you have the right plugs and slots
adopt-info: frog
icon: com.github.tenderowl.frog.svg
compression: lzo
environment:
   #WORKAROUND: Add python modules in Snap to search path
   PYTHONPATH: ${SNAP}/lib/python3.10/site-packages:${SNAP}/usr/lib/python3/dist-packages
parts:
  gtk4:
    source: https://gitlab.gnome.org/GNOME/gtk.git
    source-tag: '4.8.0'
# ext:updatesnap
#   version-format:
#     ignore-odd-minor: true
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/usr
      - -Doptimization=3
      - -Ddebug=true
      - -Dbroadway-backend=false
      - -Dx11-backend=true
      - -Dwayland-backend=true
      - -Dwin32-backend=false
      - -Dmacos-backend=false
      - -Dintrospection=enabled
      - -Dgtk_doc=false
      - -Ddemos=false
      - -Dbuild-examples=false
      - -Dbuild-tests=false
      - -Dmedia-gstreamer=disabled
      - -Ddemos=false
      - -Dbuild-examples=false
      - -Dbuild-tests=false
      - -Dprint-cups=enabled
    organize:
      usr/lib/gtk-4.0: usr/lib/$CRAFT_ARCH_TRIPLET/gtk-4.0
    build-packages:
      - libxkbcommon-dev
      - libcups2-dev
      - libcolord-dev
      - libxrandr-dev
      - libxcursor-dev
      - libisocodes-dev
      - libxcomposite-dev
      - libxdamage-dev
      - libxfixes-dev
      - libxi-dev
      - libxkbfile-dev
      - libxml2-utils
    stage:
      - -usr/bin/wayland-scanner
      - -usr/lib/*/libwayland-client.so.0.20.0
      - -usr/lib/*/libwayland-server.so.0.20.0

  #pytesseract:
  #  plugin: python
  #  source: https://github.com/madmaze/pytesseract.git
  #  source-tag: v0.3.10
  #  build-environment:
  #    # WORKAROUND: The python plugin is broken with gnome extension
  #    - PATH: ${CRAFT_PART_INSTALL}/bin:${PATH}
  #    - PYTHONPATH: ""
  #  stage:
  #    # WORKAROUND: Skip venv from python plugin
  #    - -bin/activate
  #    - -bin/activate.csh
  #    - -bin/activate.fish
  #    - -bin/Activate.ps1
  #    - -bin/python
  #    - -bin/python3
  #    - -bin/python3.10
  #    - -bin/pip
  #    - -bin/pip3
  #    - -bin/pip3.10
  #    - -pyvenv.cfg
  #  python-packages:
  #    - pyzbar
  #    - PyGObject
  frog:
    #after: [pytesseract]
    after: [gtk4]
    plugin: meson
    source: https://github.com/TenderOwl/Frog.git
    source-type: git
    #source-tag: $SNAPCRAFT_PROJECT_VERSION
    meson-parameters:
      - --prefix=/snap/frog/current/usr
    # See 'snapcraft plugins'
    build-environment:
      - pythondir: /snap/frog/current/usr/lib/python3.10/dist-packages/
    build-packages:
      - libleptonica-dev
      - libportal-gtk3-dev
      - tesseract-ocr
    stage-packages:
      - libgtk-4-1
      - tesseract-ocr
      - leptonica-progs
      - zbar-tools
    override-pull: |
      craftctl default
      sed -e "s|install_subdir('frog', install_dir: pythondir)|install_subdir('frog', install_dir: '/snap/frog/current/usr/lib/python3/dist-packages')|g" -i meson.build
    override-build: |
      craftctl default
      pip install --target=$CRAFT_PART_INSTALL/snap/frog/current/usr/lib/python3/dist-packages pytesseract
      pip install --target=$CRAFT_PART_INSTALL/snap/frog/current/usr/lib/python3/dist-packages pyzbar
      # WORKAROUND: Use python from search path, the path detected by meson doesn't exist when running the Snap
      sed -e '1c#!/usr/bin/env python3' -i "${CRAFT_PART_INSTALL}/snap/frog/current/usr/bin/frog"
    parse-info: [usr/share/appdata/com.github.tenderowl.frog.appdata.xml]
    organize:
      snap/frog/current/usr: usr

apps:
  frog:
    command: usr/bin/frog
    common-id: com.github.tenderowl.frog
    extensions: [gnome]
    desktop: usr/share/applications/com.github.tenderowl.frog.desktop
    environment:
      XDG_DATA_HOME: $SNAP_USER_DATA/.local/share
    plugs:
      - network

